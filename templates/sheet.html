{% extends "base.html" %}

{% block title %}{{ character.name }} - Character Compendium{% endblock %}

{% block content %}

{# Pre-compute effective values used across sections #}
{% set str_bonus = bonuses.get('str_score', 0) %}
{% set int_bonus = bonuses.get('int_score', 0) %}
{% set prof_bonus = bonuses.get('proficiency_bonus', 0) %}
{% set effective_str = character.str_score + str_bonus %}
{% set effective_int = character.int_score + int_bonus %}
{% set effective_prof = character.proficiency_bonus + prof_bonus %}
{% set str_mod = ((effective_str - 10) // 2) if effective_str >= 10 else ((effective_str - 11) // 2) %}
{% set int_mod = ((effective_int - 10) // 2) if effective_int >= 10 else ((effective_int - 11) // 2) %}

<div class="character-sheet">

    <!-- ==================== CHARACTER DATA FORM ==================== -->
    <form method="POST" action="{{ url_for('update_character', character_id=character.id) }}">
        
        <!-- Header Section -->
        <div class="sheet-header">
            <div class="form-group">
                <label for="name">Character Name</label>
                <input type="text" id="name" name="name" value="{{ character.name }}" class="input-large">
            </div>
            <div class="header-row">
                <div class="form-group">
                    <label for="class">Class</label>
                    <input type="text" id="class" name="class" value="{{ character.class or '' }}">
                </div>
                <div class="form-group">
                    <label for="level">Level</label>
                    <input type="number" id="level" name="level" value="{{ character.level }}" min="1" max="20">
                </div>
                <div class="form-group">
                    <label for="race">Race</label>
                    <input type="text" id="race" name="race" value="{{ character.race or '' }}">
                </div>
            </div>
        </div>

        <div class="sheet-columns">
            <!-- Left Column -->
            <div class="left-column">
                
                <!-- Ability Scores -->
                <div class="section ability-scores">
                    <h3>Ability Scores</h3>
                    
                    <div class="ability-score">
                        <label>Strength</label>
                        {% if str_bonus %}
                        <div class="effective-score">{{ effective_str }}</div>
                        <div class="base-score-row">
                            <input type="number" name="str_score" value="{{ character.str_score }}" min="1" max="30" class="score-input-small">
                            <span class="bonus-tag">+{{ str_bonus }}</span>
                        </div>
                        {% else %}
                        <input type="number" name="str_score" value="{{ character.str_score }}" min="1" max="30" class="score-input">
                        {% endif %}
                        <div class="modifier">{{ str_mod }}</div>
                    </div>
                    
                    <div class="ability-score">
                        <label>Intelligence</label>
                        {% if int_bonus %}
                        <div class="effective-score">{{ effective_int }}</div>
                        <div class="base-score-row">
                            <input type="number" name="int_score" value="{{ character.int_score }}" min="1" max="30" class="score-input-small">
                            <span class="bonus-tag">+{{ int_bonus }}</span>
                        </div>
                        {% else %}
                        <input type="number" name="int_score" value="{{ character.int_score }}" min="1" max="30" class="score-input">
                        {% endif %}
                        <div class="modifier">{{ int_mod }}</div>
                    </div>
                </div>

                <!-- Proficiency Bonus -->
                <div class="section proficiency-section">
                    <label for="proficiency_bonus">Proficiency Bonus</label>
                    {% if prof_bonus %}
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="effective-inline">{{ effective_prof }}</span>
                        <input type="number" name="proficiency_bonus" value="{{ character.proficiency_bonus }}" min="0" class="bonus-input-small">
                        <span class="bonus-tag">+{{ prof_bonus }}</span>
                    </div>
                    {% else %}
                    <input type="number" name="proficiency_bonus" value="{{ character.proficiency_bonus }}" min="0" class="bonus-input">
                    {% endif %}
                </div>

                <!-- Saving Throws -->
                <div class="section saves">
                    <h3>Saving Throws</h3>
                    
                    <div class="skill-item">
                        <input type="checkbox" id="str_save_prof" name="str_save_prof" value="1" {% if character.str_save_prof %}checked{% endif %}>
                        <label for="str_save_prof">Strength</label>
                        <span class="skill-bonus">
                            {% set str_save_equip = bonuses.get('str_save', 0) %}
                            {{ str_mod + (effective_prof if character.str_save_prof else 0) + str_save_equip }}
                            {% if str_save_equip %}<span class="equip-bonus-inline" title="Includes +{{ str_save_equip }} from items">*</span>{% endif %}
                        </span>
                    </div>
                    <div class="skill-item">
                        <input type="checkbox" id="int_save_prof" name="int_save_prof" value="1" {% if character.int_save_prof %}checked{% endif %}>
                        <label for="int_save_prof">Intelligence</label>
                        <span class="skill-bonus">
                            {% set int_save_equip = bonuses.get('int_save', 0) %}
                            {{ int_mod + (effective_prof if character.int_save_prof else 0) + int_save_equip }}
                            {% if int_save_equip %}<span class="equip-bonus-inline" title="Includes +{{ int_save_equip }} from items">*</span>{% endif %}
                        </span>
                    </div>
                </div>

                <!-- Skills -->
                <div class="section skills">
                    <h3>Skills</h3>
                    
                    {% set skill_list = [
                        ('athletics_prof', 'Athletics (Str)', str_mod, 'athletics'),
                        ('arcana_prof', 'Arcana (Int)', int_mod, 'arcana'),
                        ('history_prof', 'History (Int)', int_mod, 'history'),
                        ('investigation_prof', 'Investigation (Int)', int_mod, 'investigation'),
                        ('nature_prof', 'Nature (Int)', int_mod, 'nature'),
                        ('religion_prof', 'Religion (Int)', int_mod, 'religion'),
                    ] %}
                    
                    {% for field, label, base_mod, bonus_key in skill_list %}
                    {% set skill_equip = bonuses.get(bonus_key, 0) %}
                    <div class="skill-item">
                        <input type="checkbox" id="{{ field }}" name="{{ field }}" value="1" {% if character[field] %}checked{% endif %}>
                        <label for="{{ field }}">{{ label }}</label>
                        <span class="skill-bonus">
                            {{ base_mod + (effective_prof if character[field] else 0) + skill_equip }}
                            {% if skill_equip %}<span class="equip-bonus-inline" title="Includes +{{ skill_equip }} from items">*</span>{% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                
                <!-- Combat Stats -->
                <div class="combat-stats">
                    {% set ac_bonus = bonuses.get('ac', 0) %}
                    <div class="stat-box">
                        <label>Armor Class</label>
                        {% if ac_bonus %}
                        <div class="effective-stat">{{ character.ac + ac_bonus }}</div>
                        <div class="base-stat-row">
                            <span class="base-label">Base</span>
                            <input type="number" name="ac" value="{{ character.ac }}" min="0" class="stat-input-small">
                            <span class="bonus-tag">+{{ ac_bonus }}</span>
                        </div>
                        {% else %}
                        <input type="number" name="ac" value="{{ character.ac }}" min="0" class="stat-input">
                        {% endif %}
                    </div>

                    {% set hp_bonus = bonuses.get('hp_max', 0) %}
                    <div class="stat-box">
                        <label>Hit Points</label>
                        {% if hp_bonus %}
                        <div class="hp-inputs">
                            <input type="number" name="hp_current" value="{{ character.hp_current }}" min="0" class="stat-input" placeholder="Current">
                            <span>/</span>
                            <span class="effective-stat-inline">{{ character.hp_max + hp_bonus }}</span>
                        </div>
                        <div class="base-stat-row">
                            <span class="base-label">Base max</span>
                            <input type="number" name="hp_max" value="{{ character.hp_max }}" min="0" class="stat-input-small">
                            <span class="bonus-tag">+{{ hp_bonus }}</span>
                        </div>
                        {% else %}
                        <div class="hp-inputs">
                            <input type="number" name="hp_current" value="{{ character.hp_current }}" min="0" class="stat-input" placeholder="Current">
                            <span>/</span>
                            <input type="number" name="hp_max" value="{{ character.hp_max }}" min="0" class="stat-input" placeholder="Max">
                        </div>
                        {% endif %}
                    </div>

                    {% set mana_bonus = bonuses.get('mana_max', 0) %}
                    <div class="stat-box">
                        <label>Mana</label>
                        {% if mana_bonus %}
                        <div class="hp-inputs">
                            <input type="number" name="mana_current" value="{{ character.mana_current }}" min="0" class="stat-input" placeholder="Current">
                            <span>/</span>
                            <span class="effective-stat-inline">{{ character.mana_max + mana_bonus }}</span>
                        </div>
                        <div class="base-stat-row">
                            <span class="base-label">Base max</span>
                            <input type="number" name="mana_max" value="{{ character.mana_max }}" min="0" class="stat-input-small">
                            <span class="bonus-tag">+{{ mana_bonus }}</span>
                        </div>
                        {% else %}
                        <div class="hp-inputs">
                            <input type="number" name="mana_current" value="{{ character.mana_current }}" min="0" class="stat-input" placeholder="Current">
                            <span>/</span>
                            <input type="number" name="mana_max" value="{{ character.mana_max }}" min="0" class="stat-input" placeholder="Max">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Features & Traits -->
                <div class="section text-section">
                    <h3>Features & Traits</h3>
                    <textarea name="features" rows="8">{{ character.features or '' }}</textarea>
                </div>

                <!-- Custom Abilities -->
                <div class="section text-section">
                    <h3>Custom Abilities</h3>
                    <textarea name="custom_abilities" rows="8">{{ character.custom_abilities or '' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="sheet-footer">
            <button type="submit" class="btn btn-primary btn-large">Save Changes</button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </form>
    <!-- ==================== END CHARACTER DATA FORM ==================== -->


    <!-- ==================== INVENTORY SECTION (outside the form) ==================== -->
    <div class="section inventory-section">
        <div class="section-header">
            <h3>Inventory</h3>
            <button type="button" class="btn btn-primary btn-small" onclick="openAddItemModal()">+ Add Item</button>
        </div>

        {% if inventory %}
        <div class="inventory-list">
            {% for item in inventory %}
            <div class="inventory-item {{ 'equipped' if item.equipped else '' }}">
                <div class="item-summary" onclick="toggleItemExpand(this)">
                    <div class="item-name-row">
                        {% if item.equipped %}
                        <span class="equip-dot" title="Equipped"></span>
                        {% endif %}
                        <span class="item-name">{{ item.name }}</span>
                        {% if item.quantity is not none %}
                        <span class="item-quantity">√ó{{ item.quantity }}</span>
                        {% endif %}
                    </div>
                    <span class="item-expand-icon">‚ñ∏</span>
                </div>
                <div class="item-details">
                    {% if item.location %}
                    <div class="item-location">üìç {{ item.location }}</div>
                    {% endif %}
                    {% if item.description %}
                    <div class="item-description">{{ item.description }}</div>
                    {% endif %}
                    {% if item.properties %}
                    <div class="item-properties">
                        {% for prop in item.properties %}
                        <span class="item-property-tag">
                            {{ dict(stat_options)[prop.stat_modified] }}
                            {{ '+' if prop.value >= 0 else '' }}{{ prop.value }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <div class="item-actions">
                        <form method="POST" action="{{ url_for('toggle_equip_item', character_id=character.id, item_id=item.id) }}" class="inline-form">
                            <button type="submit" class="btn btn-small {{ 'btn-secondary' if item.equipped else 'btn-equip' }}">
                                {{ 'Remove' if item.equipped else '‚¨Ü Equip' }}
                            </button>
                        </form>
                        <button type="button" class="btn btn-small btn-secondary" onclick="openEditItemModal({{ item.id }})">‚úé Edit</button>
                        <form method="POST" action="{{ url_for('delete_inventory_item', character_id=character.id, item_id=item.id) }}" class="inline-form">
                            <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Remove {{ item.name }} from inventory?')">
                                ‚úï Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-inventory">No items yet. Add your first item!</div>
        {% endif %}
    </div>
    <!-- ==================== END INVENTORY ==================== -->

</div>

<!-- ==================== INVENTORY MODAL (standalone form) ==================== -->
<div id="inventory-modal" class="modal-overlay" 
     data-stat-options='{{ stat_options | tojson }}'>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Add Item</h3>
            <button type="button" class="modal-close" onclick="closeItemModal()">‚úï</button>
        </div>
        <form method="POST" 
              data-add-url="{{ url_for('add_inventory_item', character_id=character.id) }}"
              data-character-id="{{ character.id }}"
              action="{{ url_for('add_inventory_item', character_id=character.id) }}">
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="item-name">Item Name</label>
                    <input type="text" id="item-name" name="item_name" required>
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" name="item_description" rows="3"></textarea>
                </div>

                <div class="form-row-modal">
                    <div class="form-group">
                        <label for="item-location">Location</label>
                        <input type="text" id="item-location" name="item_location" placeholder="e.g. Belt pouch, Backpack">
                    </div>
                    <div class="form-group">
                        <label for="item-quantity">Quantity</label>
                        <input type="number" id="item-quantity" name="item_quantity" min="1" placeholder="‚Äî">
                    </div>
                </div>

                <div class="form-group">
                    <label>Properties</label>
                    <div id="properties-container"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addPropertyRow()">+ Add Property</button>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Item</button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='inventory.js') }}"></script>
{% endblock %}
